<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <script src="components/loader.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="css/style.css">
    <title>ゲームオーバー</title>
    <script>
      var WKAI;
      var WHP;
      var WATK;
      var WMP;
      var WLV;
      var WW;
      var WS1;
      var WS2;
      var txthantei;
      var name;
      var applicationKey="c4c973d149eb7f703b8dc11532c2fb3e3bb2a7efcbd08a6f365e6b985e850f28";
      var clientKey="202e48eb74bebfc63486928f9388cd363f0636806e35cefa57472e8045a9f7c1";
      var KAI= new Array();
      var HP = new Array();
      var ATK= new Array();
      var MP= new Array();
      var LV= new Array();
      var Bhantei= new Array();
      var skil1= new Array();
      var skil2= new Array();
      var MyID;
      window.onload = function(){
        document.body.style.backgroundImage = 'url(PNG/tower.png)';
      Lname=localStorage.getItem("name");
      MyID=localStorage.getItem("id");
      MyID=Number(MyID);
      var ncmb = new NCMB(applicationKey,clientKey);
      window.SampleData = ncmb.DataStore("playerdata");
      Lname=localStorage.getItem("name");
      SampleData.equalTo("id",MyID).fetchAll()
      .then(function(results){
          WKAI=results[0].KAI;
          maxkai=results[0].wKAI;
          WHP=results[0].MAXHP;
          WATK=results[0].ATK;
          WMP=results[0].MAXMP;
          WLV=results[0].LV;
          WW=results[0].Bhantei;
          WS1=results[0].skil1;
          WS2=results[0].skil2;
      Start = document.getElementById("kai");
      Start.innerHTML=WKAI;
      Start = document.getElementById("hp");
      Start.innerHTML=WHP;
      Start = document.getElementById("atk");
      Start.innerHTML=WATK;
      Start = document.getElementById("mp");
      Start.innerHTML=WMP;
      Start = document.getElementById("lv");
      Start.innerHTML=WLV;
      Start = document.getElementById("keikenti");
      Start.innerHTML=WLV;
      Start = document.getElementById("Prank");
      Start.innerHTML=results[0].PLV;
      Start = document.getElementById("coin");
      Start.innerHTML=results[0].Zcoin;
      Start = document.getElementById("diamond");
      Start.innerHTML=results[0].Zdiamond;
      if(WW==0){
        Start = document.getElementById("buki");
        Start.innerHTML="武器無し";
      }else if(WW==1){
        Start = document.getElementById("buki");
        Start.innerHTML="剣";
      }else if(WW==2){
        Start = document.getElementById("buki");
        Start.innerHTML="盾";
      }
      if(WS1==1){
        Start = document.getElementById("scr1");
        Start.src="skil/tate.png";
        Start = document.getElementById("s1");
        Start.innerHTML="縦";
      }else if(WS1==2){
        Start = document.getElementById("scr1");
        Start.src="skil/yoko.png";
        Start = document.getElementById("s1");
        Start.innerHTML="横";
      }else if(WS1==3){
        Start = document.getElementById("scr1");
        Start.src="skil/hidarinaname.png";
        Start = document.getElementById("s1");
        Start.innerHTML="左斜め";
      }else if(WS1==4){
        Start = document.getElementById("scr1");
        Start.src="skil/miginaname.png";
        Start = document.getElementById("s1");
        Start.innerHTML="右斜め";
      }else if(WS1==5){
        Start = document.getElementById("scr1");
        Start.src="skil/miginaname.png";
        Start = document.getElementById("s1");
        Start.innerHTML="十字";
      }
      else if(WS1==6){
        Start = document.getElementById("scr1");
        Start.src="skil/miginaname.png";
        Start = document.getElementById("s1");
        Start.innerHTML="斜め十字";
      }
      if(WS2==1){
        Start = document.getElementById("scr2");
        Start.src="skil/tate.png";
        Start = document.getElementById("s2");
        Start.innerHTML="縦";
      }else if(WS2==2){
        Start = document.getElementById("scr2");
        Start.src="skil/yoko.png";
        Start = document.getElementById("s2");
        Start.innerHTML="横";
      }else if(WS2==3){
        Start = document.getElementById("scr2");
        Start.src="skil/hidarinaname.png";
        Start = document.getElementById("s2");
        Start.innerHTML="左斜め";
      }else if(WS2==4){
        Start = document.getElementById("scr2");
        Start.src="skil/miginaname.png";
        Start = document.getElementById("s2");
        Start.innerHTML="右斜め";
      }else if(WS2==5){
        Start = document.getElementById("scr2");
        Start.src="skil/miginaname.png";
        Start = document.getElementById("s2");
        Start.innerHTML="十字";
      }
      else if(WS2==6){
        Start = document.getElementById("scr2");
        Start.src="skil/miginaname.png";
        Start = document.getElementById("s2");
        Start.innerHTML="斜め十字";
      }
      
      
      var rank= new Array();
      rank[0]=0;
      rank[1]=0;
      rank[2]=0;
      var rankid=new Array();
      var kaburi=99;
      var RANKING = ncmb.DataStore("ranking");
        RANKING.order("rank").fetchAll()
        .then(function(results){
        console.log("取得成功:" + JSON.stringify(results));
        for(var y=0;y<results.length;y++){
            rank[y]=results[y].KAI;
            rankid[y]=results[y].id;
            KAI[y]=results[y].KAI;
            HP[y]=results[y].HP;
            ATK[y]=results[y].ATK;
            MP[y]=results[y].MP;
            LV[y]=results[y].LV;
            Bhantei[y]=results[y].Bhantei;
            skil1[y]=results[y].skil1;
            skil2[y]=results[y].skil2;
        }
        console.log(rank[0]+" "+rank[1]+" "+rank[2]+" "+WKAI);
        if(maxkai<WKAI){
        txthantei=0;
        if(rank[0]<WKAI){
          txthantei=1;
        }else if(rank[1]<WKAI){
          txthantei=2;
        }else if(rank[2]<WKAI){
          txthantei=3;
        }
        if(rankid[0]==MyID){
          kaburi=1;
        }else if(rankid[1]==MyID){
          kaburi=2;
        }else if(rankid[2]==MyID){
          kaburi=3;
        }
        console.log(txthantei+" "+kaburi);
        console.log(KAI[0]+" "+KAI[1]+" "+KAI[2]+" "+HP[0]);
          if(txthantei==1){
            Start = document.getElementById("ranking");
            Start.innerHTML="あなたのランキングは１位です！おめでとうございます！";
            var RANKING1 = ncmb.DataStore("ranking");
            RANKING1.equalTo("rank",1).fetch()
          .then(function(RANKING1){
          RANKING1.set("KAI",WKAI);
            RANKING1.set("HP",WHP);
            RANKING1.set("ATK",WATK);
            RANKING1.set("MP",WMP);
            RANKING1.set("LV",WLV);
            RANKING1.set("Bhantei",WW);
            RANKING1.set("skil1",WS1);
            RANKING1.set("skil2",WS2);
            RANKING1.set("name",Lname);
            return RANKING1.update();
          })
          if(kaburi>1){ 
              var RANKING2 = ncmb.DataStore("ranking");
          RANKING2.equalTo("rank",2).fetch()
            .then(function(RANKING2){
                RANKING2.set("KAI",KAI[0]);
                RANKING2.set("HP",HP[0]);
                RANKING2.set("ATK",ATK[0]);
                RANKING2.set("MP",MP[0]);
                RANKING2.set("LV",LV[0]);
                RANKING2.set("Bhantei",Bhantei[0]);
                RANKING2.set("skil1",skil1[0]);
                RANKING2.set("skil2",skil2[0]);
                return RANKING2.update();
          })
          }
          if(kaburi>2){
              var RANKING3 = ncmb.DataStore("ranking");
            RANKING3.equalTo("rank",3).fetch()
            .then(function(RANKING3){
              RANKING3.set("KAI",KAI[1]);
              RANKING3.set("HP",HP[1]);
              RANKING3.set("ATK",ATK[1]);
              RANKING3.set("MP",MP[1]);
              RANKING3.set("LV",LV[1]);
              RANKING3.set("Bhantei",Bhantei[1]);
              RANKING3.set("skil1",skil1[1]);
              RANKING3.set("skil2",skil2[1]);
              return RANKING3.update();
          })
          }
            txthantei=1;
            }else if(txthantei==2){
                Start = document.getElementById("ranking");
                Start.innerHTML="あなたのランキングは2位です！次は１位を目指して頑張りましょう！";
                if(kaburi>2){
                    var RANKING3 = ncmb.DataStore("ranking");
                RANKING.equalTo("rank",3).fetch()
                    .then(function(RANKING3){
                    RANKING3.set("KAI",KAI[1]);
                    RANKING3.set("HP",HP[1]);
                    RANKING3.set("ATK",ATK[1]);
                    RANKING3.set("MP",MP[1]);
                    RANKING3.set("LV",LV[1]);
                    RANKING3.set("Bhantei",Bhantei[1]);
                    RANKING3.set("skil1",skil1[1]);
                    RANKING3.set("skil2",skil2[1]);
                    return RANKING3.update();
                })
                }
                var RANKING2 = ncmb.DataStore("ranking");
                RANKING2.equalTo("rank",2).fetch()
                .then(function(RANKING1){
                RANKING1.set("KAI",WKAI);
                    RANKING1.set("HP",WHP);
                    RANKING1.set("ATK",WATK);
                    RANKING1.set("MP",WMP);
                    RANKING1.set("LV",WLV);
                    RANKING1.set("Bhantei",WW);
                    RANKING1.set("skil1",WS1);
                    RANKING1.set("skil2",WS2);
                    RANKING1.set("name",Lname);
                    return RANKING1.update();
                })
                txthantei=2;
                }else if(txthantei==3){
                    Start = document.getElementById("ranking");
                    Start.innerHTML="あなたのランキングは3位です！次は１位を目指して頑張りましょう！";
                    var RANKING3 = ncmb.DataStore("ranking");
                    RANKING3.equalTo("rank",3).fetch()
                    .then(function(RANKING3){
                    RANKING3.set("KAI",WKAI);
                        RANKING3.set("HP",WHP);
                        RANKING3.set("ATK",WATK);
                        RANKING3.set("MP",WMP);
                        RANKING3.set("LV",WLV);
                        RANKING3.set("Bhantei",WW);
                        RANKING3.set("skil1",WS1);
                        RANKING3.set("skil2",WS2);
                        RANKING3.set("name",Lname);
                        return RANKING3.update();
                    })
                    txthantei=3;
                  }else{
                    Start = document.getElementById("ranking");
                    Start.innerHTML="あなたのランキングは4位以下です！次は３位以内を目指して頑張りましょう！";
                  }
                    SampleData.equalTo("username",Lname).fetch()
                    .then(function(SampleData){
                        SampleData.set("wKAI",WKAI);
                        SampleData.set("wHP",WHP);
                        SampleData.set("wATK",WATK);
                        SampleData.set("wMAXMP",WMP);
                        SampleData.set("wLV",WLV);
                        SampleData.set("wBhantei",WW);
                        SampleData.set("wskil1",WS1);
                        SampleData.set("wskil2",WS2);
                        SampleData.set("KAI",1);
                        SampleData.set("MAXHP",1);
                        SampleData.set("ATK",1);
                        SampleData.set("MAXMP",1);
                        SampleData.set("LV",1);
                        SampleData.set("Bhantei",0);
                        SampleData.set("skil1",1);
                        SampleData.set("skil2",1);
                        SampleData.set("syou1",99);
                        return SampleData.update();
                    })
                    Start = document.getElementById("max");
                    Start.innerHTML="自己最高記録を更新しました！次回も頑張りましょう！";
                }else{
                    Start = document.getElementById("max");
                    Start.innerHTML="自己最高記録は更新されませんでした。次回頑張りましょう！";
                }
                
            })
        })
      } 
    </script>
</head>
<body>
  <div style="display: flex;justify-content: center;">
  <img src="PNG/gameover.png" width="300" height="130" >
  </div>
  <div style="padding: 10px; margin-bottom: 10px; border: 5px double #333333; background-color: #ffff99;">
  到達階:<a id="kai"></a><br>
  最高LV:<a id="lv"></a><br>
  最高HP:<a id="hp"></a><br>
  最高ATK:<a id="atk"></a><br>
  最高MP:<a id="mp"></a><br>
  所持武器:<a id="buki"></a><br>
  経験値を<a id="keikenti"></a>獲得しランクが<a id="Prank"></a>になりました<br>
  獲得コイン:<a id="coin"></a><br>
  獲得ダイヤ:<a id="diamond"></a><br>
  スキル１:<a id="s1"></a><br>
  <img src="skil/none.png" width="50" height="65"id="scr1"><br>
  スキル２:<a id="s2"></a><br>
  <img src="skil/none.png" width="50" height="65"id="scr2"><br>
  <a id="ranking"></a><br>
  <a id="max"></a><br>
  </div>
  <div style="display: flex;justify-content: center;">
    <a href="menu.html"><img src="PNG/return.png" width="300" height="100"></a>
    </div>
</body>
</html>
